<!DOCTYPE html>
<html>
<head>
    <title>RT360 Scanner</title>
    <style>
        body {
            font-family: sans-serif;
            text-align: center;
            background-color: #f9f9f9;
        }

        .main-container {
            display: flex;
            justify-content: center;
            gap: 50px;
            margin-top: 10px;
        }

        .camera-container {
            border: 1px solid #ccc;
            padding: 20px;
            background: #fff;
            width: 600px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .camera-title {
            font-size: 1.5em;
            margin-bottom: 10px;
        }

		.video-feed {
			position: relative;
			width: 600px;
			height: 600px;
			background-image: none;
			background-size: cover;
			background-position: center;
			margin-bottom: 30px;
			display: flex;
			align-items: center;
			justify-content: center;
		}

		.video-feed img {
			transform: rotate(90deg);
			max-height: 100%;
			max-width: 100%;
			object-fit: contain;
		}

        .controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .controls form {
            display: inline-block;
        }

        .global-controls {
			padding-bottom: 18px;
			margin-top: 20px;

        }

        button {
            padding: 10px 14px;
            font-size: 14px;
        }
        
        .focus-controls {
			margin-top: 10px;
			padding: 10px;
			background: #f5f5f5;
			border-radius: 5px;
		}

		.focus-slider {
			width: 200px;
			margin: 0 10px;
			vertical-align: middle;
		}
		
        .progress-container {
            width: 80%;
            margin: 20px auto;
            background-color: #e0e0e0;
            border-radius: 5px;
            overflow: hidden;
            display: none; /* Skriveno po defaultu */
        }

        .progress-bar {
            width: 0%;
            height: 30px;
            background-color: #4CAF50;
            text-align: center;
            line-height: 30px;
            color: white;
            border-radius: 5px;
            transition: width 0.3s ease-in-out;
        }

        .progress-text {
            margin-top: 10px;
            font-size: 1.2em;
            font-weight: bold;
        }
    </style>
</head>
<body>

    <div class="main-container">
        <!-- Kamera 0 -->
        <div class="camera-container">
            <div class="camera-title">KAMERA 0</div>
            <div class="video-feed">
                {% if preview_active %}
					<img src="{{ url_for('video_feed', cam_id=0) }}">
				{% else %}
					<img src="{{ url_for('static', filename='no_signal.png') }}">
				{% endif %}
            </div>
            <div class="controls">
                <form action="{{ url_for('zoom', cam_id=0, action='in') }}"><button>Zoom In</button></form>
                <form action="{{ url_for('zoom', cam_id=0, action='out') }}"><button>Zoom Out</button></form>
                <form action="{{ url_for('zoom', cam_id=0, action='reset') }}"><button>Reset Zoom</button></form>
            </div>
            <!-- Fokus kontrole -->
			<div class="focus-controls">
				<button onclick="triggerAutofocus(0)">Autofokus</button>
				<input type="range" min="{{ FOCUS_MIN }}" max="{{ FOCUS_MAX }}" step="{{ FOCUS_STEP }}" 
                    value="{{ focus_values[0] }}" class="focus-slider" id="slider-0" 
                    oninput="updateFocus(0, this.value)">
				<span id="focus-value-0">{{ focus_values[0] }}</span>
			</div>
        </div>

        <!-- Kamera 1 -->
        <div class="camera-container">
            <div class="camera-title">KAMERA 1</div>
            <div class="video-feed">
				{% if preview_active %}
					<img src="{{ url_for('video_feed', cam_id=1) }}">
				{% else %}
					<img src="{{ url_for('static', filename='no_signal.png') }}">
				{% endif %}
            </div>
            <div class="controls">
                <form action="{{ url_for('zoom', cam_id=1, action='in') }}"><button>Zoom In</button></form>
                <form action="{{ url_for('zoom', cam_id=1, action='out') }}"><button>Zoom Out</button></form>
                <form action="{{ url_for('zoom', cam_id=1, action='reset') }}"><button>Reset Zoom</button></form>
            </div>
                 <!-- Fokus kontrole -->
			<div class="focus-controls">
				<button onclick="triggerAutofocus(1)">Autofokus</button>
				<input type="range" min="{{ FOCUS_MIN }}" max="{{ FOCUS_MAX }}" 
                    step="{{ FOCUS_STEP }}" value="{{ focus_values[1] }}" class="focus-slider" id="slider-1" 
                    oninput="updateFocus(1, this.value)">
				<span id="focus-value-1">{{ focus_values[1] }}</span>
			</div>   
        </div>
    </div>

    <!-- Globalni gumbi -->
    <div class="global-controls">
		<div class="progress-container" id="scanProgressBarContainer">
			<div class="progress-bar" id="scanProgressBar">0%</div>
		</div>
		<p class="progress-text" id="scanProgressText"></p>
        <form action="{{ url_for('start_preview') }}" style="display:inline-block;"><button onclick="hideBackground()">Start Preview</button></form>
        <form action="{{ url_for('stop_preview') }}" style="display:inline-block;"><button onclick="showBackground()">Stop Preview</button></form>
        <form action="{{ url_for('take_picture_route') }}" style="display:inline-block;"><button>&#128247;Take Picture</button></form>
        <form action="{{ url_for('new_folder') }}" method="get" style="display:inline-block;"><button>&#128193 Novi folder</button></form>
        <form action="{{ url_for('start_scan') }}" method="get" style="display:inline-block;"><button>&#128247; Start 360 Scan</button></form>
		<form action="{{ url_for('cancel_scan') }}" method="get" style="display:inline-block;"><button>&#10060; Cancel Scan</button></form>
		<p><strong>Aktivni folder:</strong> <span style="font-size: 1.5em;">{{ active_folder }}</span></p>

    </div>
    
	<script>
	const scanProgressBarContainer = document.getElementById('scanProgressBarContainer');
    const scanProgressBar = document.getElementById('scanProgressBar');
    const scanProgressText = document.getElementById('scanProgressText');
	const element = document.querySelector('.video-feed');
	function hideBackground() {
		element.style.backgroundImage = 'none';
	}
	function showBackground() {
		element.style.backgroundImage = 'url(/static/no_signal.png)';
	}
	
	// Autofokus za odabranu kameru
	function triggerAutofocus(camId) {
		fetch(`/autofocus/${camId}`)
			.then(response => {
				if (!response.ok) throw new Error(`Kamera ${camId} nije dostupna`);
				console.log(`Autofokus kamera ${camId} pokrenut`);
			})
			.catch(error => console.error(error));
	}

	// Rucni fokus za odabranu kameru
	function updateFocus(camId, value) {
		const formData = new FormData();
		formData.append("value", value);
		
		fetch(`/set_focus/${camId}`, {
			method: "POST",
			body: formData
		})
		.then(response => {
			if (!response.ok) throw new Error("Greska u postavljanju fokusa");
			document.getElementById(`focus-value-${camId}`).textContent = value;
		})
		.catch(error => {
			console.error(error);
			// Vrati slider na prethodnu vrijednost
			document.getElementById(`slider-${camId}`).value = focus_values[camId];
		});
	}
	
	// Funkcija za azuriranje progress bara
    function updateScanProgress() {
        fetch('/scan_status') // Ova ruta Ä‡e nam trebati
            .then(response => response.json())
            .then(data => {
                if (data.scan_in_progress) {
                    scanProgressBarContainer.style.display = 'block';
                    const percentage = (data.current_scan_step / data.total_scan_steps) * 100;
                    scanProgressBar.style.width = percentage + '%';
                    scanProgressBar.textContent = Math.round(percentage) + '%';
                    scanProgressText.textContent = `${data.current_scan_step}/${data.total_scan_steps} slike`;
                } else {
                    scanProgressBarContainer.style.display = 'none';
                    scanProgressText.textContent = '';
                }
            })
            .catch(error => console.error('Error fetching scan status:', error));
    }

    // Pozovi funkciju svakih par sekundi za dohvacanje statusa
    setInterval(updateScanProgress, 2000); // Azuriraj svakih 2 sekunde

    // Inicijalno stanje progress bara
    updateScanProgress();

    // Funkcije za UI feedback prilikom pokretanja/zaustavljanja skeniranja
    function startScanUI() {
        scanProgressBarContainer.style.display = 'block';
        scanProgressBar.style.width = '0%';
        scanProgressBar.textContent = '0%';
        scanProgressText.textContent = '0/{{ total_scan_steps }} slike';
    }

    function stopScanUI() {
        // Kada se otkaze skeniranje, resetiramo progress bar
        scanProgressBarContainer.style.display = 'none';
        scanProgressText.textContent = '';
        // Server ce resetirati current_scan_step na 0
    }

    </script>    

</body>
</html>
